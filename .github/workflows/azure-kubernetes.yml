name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'k8s/app/deployment.yaml'
      - 'README.md'
      - 'screenshots/**'

env:
  ACR_NAME: helmiacr2025
  IMAGE_NAME: springboot-app
  AKS_CLUSTER: springboot-aks
  RESOURCE_GROUP: springboot-rg

jobs:
  build-and-deploy:
    name: Build, Push and Deploy
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Generate unique image tag
      id: tag
      run: |
        SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        echo "sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
        echo "üì¶ Image tag: ${SHORT_SHA}"
    
    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    
    - name: Build with Maven
      run: |
        echo "üî® Building application..."
        mvn clean package -DskipTests -q
        echo "‚úÖ Maven build completed"
    
    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Build and Push Docker Image
      run: |
        IMAGE_TAG=${{ steps.tag.outputs.sha }}
        
        echo "üê≥ Building Docker image..."
        az acr login --name ${{ env.ACR_NAME }}
        
        docker build -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${IMAGE_TAG} .
        docker build -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest .
        
        echo "üì§ Pushing to ACR..."
        docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${IMAGE_TAG}
        docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
        
        echo "‚úÖ Docker image pushed successfully"
    
    - name: Update Kubernetes manifest
      run: |
        IMAGE_TAG=${{ steps.tag.outputs.sha }}
        NEW_IMAGE="${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"
        
        echo "üìù Updating deployment manifest..."
        sed -i "s|image: helmiacr2025.azurecr.io/springboot-app:.*|image: ${NEW_IMAGE}|g" k8s/app/deployment.yaml
        
        echo "‚úÖ Manifest updated with image: ${NEW_IMAGE}"
    
    - name: Commit and push manifest
      run: |
        IMAGE_TAG=${{ steps.tag.outputs.sha }}
        
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
        git add k8s/app/deployment.yaml
        
        # Check if there are changes
        if git diff --staged --quiet; then
          echo "‚ö†Ô∏è  No changes to commit"
          exit 0
        fi
        
        git commit -m "üöÄ deploy: Update image to ${IMAGE_TAG}

Automated deployment
- Image: ${IMAGE_TAG}
- Build: #${{ github.run_number }}
- Commit: ${{ github.sha }}"
        
        # Push with retry
        for i in {1..3}; do
          if git push; then
            echo "‚úÖ Manifest pushed to Git (attempt $i)"
            break
          else
            echo "‚ö†Ô∏è  Push failed, retrying... (attempt $i/3)"
            sleep 2
          fi
        done
    
    - name: Wait for ArgoCD sync
      run: |
        echo "‚è≥ Waiting for ArgoCD to sync (60 seconds)..."
        sleep 60
    
    - name: Verify deployment
      run: |
        az aks get-credentials \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name ${{ env.AKS_CLUSTER }} \
          --overwrite-existing
        
        echo "üìä Deployment status:"
        kubectl get deployment springboot-app -n springboot-app
        
        echo ""
        echo "üì¶ Pods:"
        kubectl get pods -n springboot-app
        
        echo ""
        echo "üê≥ Current image:"
        kubectl get deployment springboot-app -n springboot-app -o jsonpath='{.spec.template.spec.containers[0].image}'
        echo ""
