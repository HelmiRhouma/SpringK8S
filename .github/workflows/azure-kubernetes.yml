name: Build and Deploy (GitOps with ArgoCD)

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'k8s/app/deployment.yaml'  # Ã‰viter boucle infinie

env:
  ACR_NAME: helmiacr2025
  IMAGE_NAME: springboot-app

jobs:
  build-and-update:
    name: Build Docker Image and Update Manifest
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Generate image tag
      id: tag
      run: |
        SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        echo "sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
        echo "ğŸ·ï¸  Image tag: ${SHORT_SHA}"
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    
    - name: Build with Maven
      run: |
        echo "ğŸ“¦ Building application..."
        mvn clean package -DskipTests
    
    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Build and Push Docker Image
      run: |
        IMAGE_TAG=${{ steps.tag.outputs.sha }}
        
        echo "ğŸ” Login to ACR..."
        az acr login --name ${{ env.ACR_NAME }}
        
        echo "ğŸ³ Building Docker image..."
        docker build -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${IMAGE_TAG} .
        docker build -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest .
        
        echo "ğŸ“¤ Pushing to ACR..."
        docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${IMAGE_TAG}
        docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
        
        echo "âœ… Image pushed: ${IMAGE_TAG}"
    
    - name: Update Kubernetes Manifest
      run: |
        IMAGE_TAG=${{ steps.tag.outputs.sha }}
        NEW_IMAGE="${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"
        
        echo "ğŸ“ Updating k8s/app/deployment.yaml..."
        echo "   New image: ${NEW_IMAGE}"
        
        # Update image in deployment.yaml
        sed -i "s|image: helmiacr2025.azurecr.io/springboot-app:.*|image: ${NEW_IMAGE}|g" k8s/app/deployment.yaml
        
        echo "âœ… Manifest updated"
        echo ""
        echo "ğŸ“‹ Changes:"
        git diff k8s/app/deployment.yaml
    
    - name: Commit and Push to Git
      run: |
        IMAGE_TAG=${{ steps.tag.outputs.sha }}
        
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
        
        git add k8s/app/deployment.yaml
        
        # Only commit if there are changes
        if git diff --staged --quiet; then
          echo "âš ï¸  No changes to commit"
        else
          git commit -m "ğŸš€ Deploy: Update image to ${IMAGE_TAG}

Automated deployment by GitHub Actions
- Commit: ${{ github.sha }}
- Build: #${{ github.run_number }}
- Image: ${IMAGE_TAG}

ArgoCD will auto-sync this change in ~30 seconds"
          
          git push
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… MANIFEST PUSHED TO GIT"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ”„ ArgoCD will now:"
          echo "   1. Detect the Git change (10-30 seconds)"
          echo "   2. Sync automatically"
          echo "   3. Trigger rolling update on AKS"
          echo ""
          echo "ğŸŒ Monitor ArgoCD: http://20.75.210.13"
        fi
